<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Path Finder</title>
    <style>
      body {
        font-family: var(--vscode-font-family), "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto", "Helvetica Neue", sans-serif;
        font-size: var(--vscode-font-size, 13px);
        font-weight: var(--vscode-font-weight, 400);
        margin: 0;
        padding: 12px;
        background-color: var(--vscode-editor-background);
        color: var(--vscode-editor-foreground);
        line-height: 1.4;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
      }

      .input-section {
        margin-bottom: 24px;
      }

      h3 {
        font-family: var(--vscode-font-family), "Segoe UI", sans-serif;
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 8px 0;
        color: var(--vscode-foreground);
      }

      #jsonInput {
        width: 100%;
        height: 150px;
        padding: 12px;
        border: 1px solid var(--vscode-input-border);
        background-color: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        font-family: var(
          --vscode-editor-font-family,
          "Consolas",
          "SF Mono",
          "Monaco",
          "Inconsolata",
          "Fira Code",
          "Source Code Pro",
          monospace
        );
        font-size: var(--vscode-editor-font-size, 14px);
        font-weight: var(--vscode-editor-font-weight, 400);
        line-height: 1.3;
        resize: vertical;
        border-radius: 3px;
      }

      .buttons {
        margin: 12px 0;
        display: flex;
        gap: 8px;
      }

      button {
        padding: 6px 14px;
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: 1px solid var(--vscode-button-border, transparent);
        cursor: pointer;
        border-radius: 2px;
        font-family: var(--vscode-font-family), "Segoe UI", sans-serif;
        font-size: 13px;
        font-weight: 400;
        transition: background-color 0.1s ease;
      }

      button:hover {
        background-color: var(--vscode-button-hoverBackground);
      }

      button:focus {
        outline: 1px solid var(--vscode-focusBorder);
        outline-offset: 2px;
      }

      .tree-container {
        border: 1px solid var(--vscode-panel-border);
        background-color: var(--vscode-editor-background);
        max-height: 500px;
        overflow: auto;
        padding: 12px;
        border-radius: 3px;
      }

      .tree-node {
        margin-left: 18px;
        margin-bottom: 1px;
        line-height: 1.4;
      }

      .tree-node.root {
        margin-left: 0;
      }

      .tree-key {
        color: var(--vscode-symbolIcon-keywordForeground);
        font-family: var(--vscode-editor-font-family, "Consolas", "SF Mono", "Monaco", monospace);
        font-size: var(--vscode-editor-font-size, 13px);
        font-weight: 500;
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 2px;
        transition: background-color 0.15s ease;
      }

      .tree-key:hover {
        background-color: var(--vscode-list-hoverBackground);
      }

      .tree-value {
        color: var(--vscode-symbolIcon-stringForeground);
        font-family: var(--vscode-editor-font-family, "Consolas", "SF Mono", "Monaco", monospace);
        font-size: var(--vscode-editor-font-size, 13px);
        margin-left: 6px;
        font-weight: 400;
      }

      .tree-type {
        color: var(--vscode-symbolIcon-colorForeground);
        font-family: var(--vscode-font-family), "Segoe UI", sans-serif;
        font-style: italic;
        font-size: 12px;
        opacity: 0.8;
      }

      .expandable {
        cursor: pointer;
        position: relative;
      }

      .expandable::before {
        content: "▶";
        color: var(--vscode-symbolIcon-colorForeground);
        font-size: 11px;
        margin-right: 4px;
        transition: transform 0.2s ease;
        display: inline-block;
      }

      .expanded::before {
        content: "▼";
        transform: none;
      }

      .error {
        color: var(--vscode-errorForeground);
        background-color: var(--vscode-inputValidation-errorBackground);
        padding: 12px;
        border-radius: 4px;
        margin: 12px 0;
        border-left: 3px solid var(--vscode-errorForeground);
        font-family: var(--vscode-font-family), "Segoe UI", sans-serif;
        font-size: 13px;
        line-height: 1.4;
      }

      .path-display {
        background-color: var(--vscode-textCodeBlock-background);
        border: 1px solid var(--vscode-panel-border);
        padding: 12px;
        font-family: var(--vscode-editor-font-family, "Consolas", "SF Mono", "Monaco", monospace);
        font-size: var(--vscode-editor-font-size, 13px);
        font-weight: var(--vscode-editor-font-weight, 400);
        margin: 12px 0;
        word-break: break-all;
        border-radius: 3px;
        line-height: 1.3;
      }

      .path-display strong {
        font-family: var(--vscode-font-family), "Segoe UI", sans-serif;
        font-weight: 600;
        color: var(--vscode-foreground);
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="input-section">
        <h3>JSON Input</h3>
        <textarea id="jsonInput" placeholder="Paste your JSON data here...">{{JSON_CONTENT}}</textarea>
        <div class="buttons">
          <button onclick="parseJson()">Parse JSON</button>
          <button onclick="clearInput()">Clear</button>
        </div>
      </div>

      <div id="errorContainer"></div>
      <div id="pathDisplay" class="path-display hidden">
        <strong>Path:</strong> <span id="currentPath">Click on any property below to see its path</span>
        <button onclick="copyCurrentPath()" style="margin-left: 10px; padding: 4px 8px">Copy</button>
      </div>

      <div class="tree-container">
        <div id="jsonTree">Parse JSON to see the tree structure</div>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      let currentJsonData = null;
      let currentSelectedPath = "";

      function parseJson() {
        const input = document.getElementById("jsonInput").value.trim();
        const errorContainer = document.getElementById("errorContainer");
        const jsonTree = document.getElementById("jsonTree");

        errorContainer.innerHTML = "";

        if (!input) {
          showError("Please enter JSON data");
          return;
        }

        try {
          currentJsonData = JSON.parse(input);
          renderJsonTree(currentJsonData, jsonTree, "");
          document.getElementById("pathDisplay").classList.remove("hidden");
        } catch (error) {
          showError("Invalid JSON: " + error.message);
          jsonTree.innerHTML = "Invalid JSON data";
        }
      }

      function showError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.innerHTML = '<div class="error">' + message + "</div>";
        vscode.postMessage({ command: "error", text: message });
      }

      function renderJsonTree(data, container, path) {
        container.innerHTML = "";

        if (data === null) {
          container.innerHTML = '<span class="tree-value">null</span>';
          return;
        }

        if (typeof data !== "object") {
          container.innerHTML = '<span class="tree-value">' + JSON.stringify(data) + "</span>";
          return;
        }

        if (Array.isArray(data)) {
          data.forEach((item, index) => {
            const itemPath = path ? path + "[" + index + "]" : "[" + index + "]";
            const node = createTreeNode(index, item, itemPath, true);
            container.appendChild(node);
          });
        } else {
          Object.keys(data).forEach((key) => {
            const itemPath = path ? path + "." + key : key;
            const node = createTreeNode(key, data[key], itemPath, false);
            container.appendChild(node);
          });
        }
      }

      function createTreeNode(key, value, path, isArrayIndex) {
        const node = document.createElement("div");
        node.className = "tree-node";

        const keyElement = document.createElement("span");
        keyElement.className = "tree-key";
        keyElement.textContent = isArrayIndex ? "[" + key + "]" : key;
        keyElement.onclick = () => selectPath(path);

        if (value === null) {
          keyElement.appendChild(document.createTextNode(": "));
          const valueElement = document.createElement("span");
          valueElement.className = "tree-value";
          valueElement.textContent = "null";
          keyElement.appendChild(valueElement);
          node.appendChild(keyElement);
        } else if (typeof value === "object") {
          keyElement.className += " expandable";
          keyElement.onclick = (e) => {
            toggleExpand(e.target, value, path);
            selectPath(path);
          };

          const typeElement = document.createElement("span");
          typeElement.className = "tree-type";
          typeElement.textContent = Array.isArray(value) ? " (Array[" + value.length + "])" : " (Object)";

          keyElement.appendChild(typeElement);
          node.appendChild(keyElement);

          const childContainer = document.createElement("div");
          childContainer.className = "hidden";
          renderJsonTree(value, childContainer, path);
          node.appendChild(childContainer);
        } else {
          keyElement.appendChild(document.createTextNode(": "));
          const valueElement = document.createElement("span");
          valueElement.className = "tree-value";
          valueElement.textContent = JSON.stringify(value);
          keyElement.appendChild(valueElement);
          node.appendChild(keyElement);
        }

        return node;
      }

      function toggleExpand(element, value, path) {
        const childContainer = element.parentNode.querySelector("div");
        const isExpanded = element.classList.contains("expanded");

        if (isExpanded) {
          element.classList.remove("expanded");
          childContainer.classList.add("hidden");
        } else {
          element.classList.add("expanded");
          childContainer.classList.remove("hidden");
        }
      }

      function selectPath(path) {
        currentSelectedPath = "$" + (path ? "." + path : "");
        document.getElementById("currentPath").textContent = currentSelectedPath;
      }

      function copyCurrentPath() {
        if (currentSelectedPath) {
          vscode.postMessage({
            command: "copyPath",
            path: currentSelectedPath,
          });
        }
      }

      function clearInput() {
        document.getElementById("jsonInput").value = "";
        document.getElementById("jsonTree").innerHTML = "Parse JSON to see the tree structure";
        document.getElementById("pathDisplay").classList.add("hidden");
        document.getElementById("errorContainer").innerHTML = "";
        currentJsonData = null;
        currentSelectedPath = "";
      }

      // Auto-parse if JSON content is provided
      if (document.getElementById("jsonInput").value.trim()) {
        parseJson();
      }
    </script>
  </body>
</html>
